{{ $captionScratch := newScratch }}
{{ $captionKeys := slice }}
{{ range site.RegularPages }}
    {{ if strings.HasPrefix .File.Dir "websites/captions/" }}
        {{ $captionScratch.Set .File.BaseFileName .Content }}
        {{ $captionKeys = $captionKeys | append .File.BaseFileName }}
    {{ end }}
{{ end }}
{{ $projectsSection := site.GetPage "section" "websites" }}
<div class="gallery gallery-websites">
    {{ with $projectsSection }}
        {{ $rootImages := .Resources.ByType "image" }}
        {{ range $rootImages }}
            {{ if or (eq (path.Dir .Name) ".") (eq (path.Dir .Name) "") }}
                <div class="gallery-group">
                    <div class="gallery-item mb-3">
                        {{ partial "responsive-image.html" (dict "image" . "alt" (.Title | default (path.Base .Name)) "sizes" "(max-width: 1024px) 100vw, 75vw" "loading" "lazy" "defer" true) }}
                        {{ $imgBase := strings.TrimSuffix (path.Ext .Name) (path.Base .Name) }}
                        {{ with $captionScratch.Get $imgBase }}
                            <div class="caption mt-1">{{ . }}</div>
                        {{ end }}
                    </div>
                </div>
            {{ end }}
        {{ end }}
    {{ end }}
    {{ range where .Site.RegularPages "Section" "websites" }}
        {{ $pageImages := .Resources.ByType "image" }}
        {{ if gt (len $pageImages) 0 }}
            <div class="gallery-group">
                {{ range $pageImages }}
                    <div class="gallery-item mb-3">
                        {{ partial "responsive-image.html" (dict "image" . "alt" .Title "sizes" "(max-width: 1024px) 100vw, 75vw" "loading" "lazy" "defer" true) }}
                        {{ $imgBase := strings.TrimSuffix (path.Ext .Name) (path.Base .Name) }}
                        {{ with $captionScratch.Get $imgBase }}
                            <div class="caption mt-1">{{ . }}</div>
                        {{ end }}
                    </div>
                {{ end }}
            </div>
        {{ end }}
    {{ end }}
    <div class="load-more-container" style="text-align: center; margin-top: 2rem;">
        <button id="load-more-websites" class="load-more-btn" style="display: none;">Load More</button>
    </div>
</div>

<script>
    (function() {
        // Randomize image order
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function hydrateNodes(nodes) {
            nodes.forEach(node => {
                const sources = node.querySelectorAll('source[data-srcset]');
                sources.forEach(source => {
                    source.setAttribute('srcset', source.getAttribute('data-srcset'));
                    source.removeAttribute('data-srcset');
                    if (source.hasAttribute('data-sizes')) {
                        source.setAttribute('sizes', source.getAttribute('data-sizes'));
                        source.removeAttribute('data-sizes');
                    }
                });

                const imgs = node.querySelectorAll('img[data-src]');
                imgs.forEach(img => {
                    img.setAttribute('src', img.getAttribute('data-src'));
                    img.removeAttribute('data-src');
                    if (img.hasAttribute('data-srcset')) {
                        img.setAttribute('srcset', img.getAttribute('data-srcset'));
                        img.removeAttribute('data-srcset');
                    }
                    if (img.hasAttribute('data-sizes')) {
                        img.setAttribute('sizes', img.getAttribute('data-sizes'));
                        img.removeAttribute('data-sizes');
                    }
                });
            });
        }

        function paginateGallery() {
            const gallery = document.querySelector('.gallery-websites');
            if (!gallery) return;

            const items = Array.from(gallery.querySelectorAll('.gallery-item'));
            const loadMoreBtn = document.getElementById('load-more-websites');
            const ITEMS_PER_PAGE = 20;
            let currentlyVisible = 0;

            items.forEach(item => {
                item.style.display = 'none';
            });

            function showMoreItems() {
                const end = Math.min(currentlyVisible + ITEMS_PER_PAGE, items.length);
                const toShow = items.slice(currentlyVisible, end);
                toShow.forEach(item => {
                    item.style.display = 'block';
                });
                hydrateNodes(toShow);
                currentlyVisible = end;

                if (currentlyVisible >= items.length) {
                    loadMoreBtn.style.display = 'none';
                }
            }

            showMoreItems();

            if (currentlyVisible < items.length) {
                loadMoreBtn.style.display = 'inline-block';
            }

            loadMoreBtn.addEventListener('click', showMoreItems);
        }

        // Get all groups and shuffle them
        const gallery = document.querySelector('.gallery-websites');
        if (!gallery) return;

        const groups = Array.from(gallery.querySelectorAll('.gallery-group'));
        const shuffledGroups = shuffleArray(groups);

        // Clear gallery and re-add shuffled images
        gallery.innerHTML = '';
        shuffledGroups.forEach(group => {
            gallery.appendChild(group);
        });

        paginateGallery();
    })();
</script>
