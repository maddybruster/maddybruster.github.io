{{ $captionScratch := newScratch }}
{{ $captionKeys := slice }}
{{ range site.RegularPages }}
    {{ if strings.HasPrefix .File.Dir "books/captions/" }}
        {{ $captionScratch.Set .File.BaseFileName .Content }}
        {{ $captionKeys = $captionKeys | append .File.BaseFileName }}
    {{ end }}
{{ end }}
{{ $miscSection := site.GetPage "section" "books" }}
<div class="gallery gallery-books">
    {{ with $miscSection }}
        {{ $rootImages := .Resources.ByType "image" }}
        {{ range $rootImages }}
            {{ if or (eq (path.Dir .Name) ".") (eq (path.Dir .Name) "") }}
                <div class="gallery-group">
                    <div class="gallery-item mb-3">
                        {{ partial "responsive-image.html" (dict "image" . "alt" (.Title | default (path.Base .Name)) "sizes" "(max-width: 1024px) 100vw, 75vw" "loading" "lazy" "defer" true) }}
                        {{ $imgBase := strings.TrimSuffix (path.Ext .Name) (path.Base .Name) }}
                        {{ with $captionScratch.Get $imgBase }}
                            <div class="caption mt-1">{{ . }}</div>
                        {{ end }}
                    </div>
                </div>
            {{ end }}
        {{ end }}
    {{ end }}
    {{ range where .Site.RegularPages "Section" "books" }}
        {{ $pageImages := .Resources.ByType "image" }}
        {{ if gt (len $pageImages) 0 }}
            <div class="gallery-group">
                {{ range $pageImages }}
                    <div class="gallery-item mb-3">
                        {{ partial "responsive-image.html" (dict "image" . "alt" .Title "sizes" "(max-width: 1024px) 100vw, 75vw" "loading" "lazy" "defer" true) }}
                        {{ $imgBase := strings.TrimSuffix (path.Ext .Name) (path.Base .Name) }}
                        {{ with $captionScratch.Get $imgBase }}
                            <div class="caption mt-1">{{ . }}</div>
                        {{ end }}
                    </div>
                {{ end }}
            </div>
        {{ end }}
    {{ end }}
</div>

<script>
    (function() {
        // Randomize image order
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function shuffleBooksGallery() {
            const gallery = document.querySelector('.gallery-books');
            if (!gallery) return;
            
            const groups = Array.from(gallery.querySelectorAll('.gallery-group'));
            if (groups.length === 0) return;
            
            const shuffledGroups = shuffleArray(groups);

            // Clear gallery and re-add shuffled images
            gallery.innerHTML = '';
            shuffledGroups.forEach(group => {
                gallery.appendChild(group);
            });
        }

        // Run on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', shuffleBooksGallery);
        } else {
            shuffleBooksGallery();
        }

        // Also shuffle when the books section becomes active
        const miscToggle = document.querySelector('input[data-target="view-books"]');
        if (miscToggle) {
            miscToggle.addEventListener('change', function() {
                if (this.checked) {
                    setTimeout(shuffleBooksGallery, 0);
                }
            });
        }
    })();
</script>
